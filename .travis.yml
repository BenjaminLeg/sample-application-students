language: java
jdk: oraclejdk11

# Cache the .m2 folder and .sonar to prevent downloading dependencies on each build
cache:
  directories:
    - "$HOME/.m2/repository"
    - "$HOME/.sonar/cache"

addons:
  sonarcloud:
    organization: "benjaminleg"
    token:
      secure: $SONAR_TOKEN # encrypted value of your token

# Define the services to use
services:
  - docker
#
#jobs:
#  - stage: "Build"
#    name: "Build tests and Quality Gate"
#    script:
#      - |
#              mvn clean verify sonar:sonar \
#              -Dsonar.projectKey=BenjaminLeg_sample-application-students \
#              -Dsonar.host.url=https://sonarcloud.io \
#              -Dsonar.login=$SONAR_TOKEN

script:
  - |
    mvn clean install sonar:sonar \
    -Dsonar.projectKey=BenjaminLeg_sample-application-students \
    -Dsonar.host.url=https://sonarcloud.io \
    -Dsonar.login=$SONAR_TOKEN

  - docker login -u $DOCKERHUB_USERNAME -p $DOCKERHUB_PASSWORD
  - docker build -t benjaminlegrosperso/application-students-test-db-changelog-job:latest sample-application-db-changelog-job
  - docker build -t benjaminlegrosperso/application-students-test-http-api-server:latest sample-application-http-api-server
  - docker push benjaminlegrosperso/application-students-test-db-changelog-job:latest
  - docker push benjaminlegrosperso/application-students-test-http-api-server:latest
